name: Build Linux AppImage (steamdeck-app only)

on:
  push:
    branches:
      - production

permissions:
  contents: write

jobs:
  build-steamdeck:
    runs-on: ubuntu-latest
    env:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: List workspace (debug)
        run: |
          set -eux
          echo "PWD: $(pwd)"
          echo "== root ls =="; ls -la || true
          echo "== steamdeck-app ls =="; ls -la steamdeck-app || true

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "22"

      - name: Runner diagnostics (helpful when debugging apt issues)
        run: |
          set -eux
          echo "== lsb_release =="; lsb_release -a || true
          echo "== /etc/os-release =="; cat /etc/os-release || true
          echo "== apt policy (brief) =="; apt-cache policy || true

      - name: Install system deps (for electron-builder)
        run: |
          set -eux
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            ca-certificates \
            libgtk-3-0 \
            libnotify4 \
            libnss3 \
            libxss1 \
            libxtst6 \
            libgbm1 \
            libpangocairo-1.0-0 \
            libx11-xcb1 \
            libxcomposite1 \
            libxrandr2 \
            libatk-bridge2.0-0 \
            libatk1.0-0 \
            libcups2 \
            libdbus-1-3 \
            libgdk-pixbuf2.0-0 \
            libappindicator3-1 || true

      - name: Install deps for steamdeck-app
        working-directory: steamdeck-app
        run: npm ci

      - name: Build and publish AppImage via electron-builder
        working-directory: steamdeck-app
        run: |
          # Build and auto-upload to GitHub Releases
          npx electron-builder --linux AppImage --publish always

      - name: Debug uploaded artifacts
        run: |
          echo "== Build completed =="
          echo "If electron-builder worked, release and latest-linux.yml should be visible on GitHub."
